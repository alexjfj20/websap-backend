"use strict";(self["webpackChunkwebsap"]=self["webpackChunkwebsap"]||[]).push([[434],{5226:function(e,o,n){n.d(o,{Dy:function(){return d},rJ:function(){return u}});n(8111),n(2489),n(1701);var r=n(8982);const a="websapDatabase",t=3,s="sharedMenus",c="menuImages";function i(){return new Promise(((e,o)=>{try{console.log("Intentando abrir la base de datos con versión:",t);const n=indexedDB.open(a,t);n.onerror=e=>{console.error("Error al abrir la base de datos:",e.target.error),o("Error al abrir la base de datos: "+e.target.errorCode)},n.onsuccess=n=>{const r=n.target.result;console.log("Base de datos abierta con éxito, versión:",r.version);const a=Array.from(r.objectStoreNames);if(console.log("Almacenes existentes:",a),!a.includes(s))return console.error(`El almacén ${s} no existe en la base de datos`),void o(new Error(`El almacén ${s} no existe en la base de datos`));e(r)},n.onupgradeneeded=e=>{console.log("Actualizando estructura de la base de datos a versión:",e.newVersion);const o=e.target.result;o.objectStoreNames.contains(s)||(console.log("Creando almacén:",s),o.createObjectStore(s,{keyPath:"id"})),o.objectStoreNames.contains(c)||(console.log("Creando almacén:",c),o.createObjectStore(c,{keyPath:"id"}))}}catch(n){console.error("Error crítico en IndexedDB:",n),o(n)}}))}function l(){return Math.random().toString(36).substring(2,10)+Math.random().toString(36).substring(2,10)}async function d(e){try{const n=l(),a=await(0,r.By)(),t=await Promise.all(e.map((async e=>{const o={...e};if(o.isSpecial=Boolean(e.isSpecial),console.log(`[saveMenu] Guardando ${e.name} con isSpecial=${o.isSpecial}`),o.image&&"string"===typeof o.image&&o.image.length>0)try{o.image=await(0,r.w4)(o.image,400,300,.5)}catch(n){console.warn("Error al comprimir imagen:",n),o.image=null}return o}))),c={id:n,items:t,businessInfo:a,createdAt:(new Date).toISOString()};try{const e=JSON.stringify(c).length/1048576;if(console.log(`Tamaño del menú a guardar: ${e.toFixed(2)} MB`),e>50)throw new Error(`El menú es demasiado grande (${e.toFixed(2)} MB). Reduce el tamaño de las imágenes.`)}catch(o){throw console.error("Error al verificar tamaño del menú:",o),new Error("Error al verificar tamaño del menú")}const d=await i(),u=d.transaction([s],"readwrite"),g=u.objectStore(s);return await new Promise(((e,o)=>{const r=g.put(c);r.onsuccess=()=>{console.log(`Menú guardado exitosamente con ID: ${n}`),e()},r.onerror=e=>{console.error("Error al guardar el menú:",e.target.error),o(e.target.error)}})),console.log("[saveMenu] Items a guardar:",e.length),console.log("[saveMenu] Items especiales:",e.filter((e=>e.isSpecial)).length),console.log("[saveMenu] Items regulares:",e.filter((e=>!e.isSpecial)).length),await m(),n}catch(o){throw console.error("Error al guardar el menú compartido:",o),o}}async function u(e){try{if(console.log(`Intentando recuperar menú con ID: ${e}`),!e)return console.error("ID de menú no proporcionado"),null;let i=null,l=navigator.onLine;console.log("Estado de conexión: "+(l?"Online":"Offline"));const d=async()=>{try{const e=new AbortController,o=setTimeout((()=>e.abort()),3e3),n=await fetch("/api/ping",{signal:e.signal,cache:"no-store",headers:{"Cache-Control":"no-cache"}});return clearTimeout(o),n.ok}catch(e){return console.log("Error al verificar conexión real:",e),!1}};try{console.log("Intentando cargar menú desde caché mientras verificamos conexión...");const o=await n.e(460).then(n.bind(n,3460)),r=await o.getMenuFromIndexedDB(e);r&&r.items&&r.items.length>0&&(console.log("Menú en caché encontrado y listo para uso inmediato"),i=r,i._fromCache=!0)}catch(o){console.warn("No se pudo obtener menú en caché para uso inmediato:",o)}if(l){console.log(`Obteniendo menú fresco desde el servidor con ID: ${e}`);try{const o=d(),r=await Promise.resolve().then(n.bind(n,133)),t=await o;if(!t){if(console.warn("Detectada conexión inestable o sin acceso al servidor"),l=!1,i)return i;throw new Error("Sin conexión real al servidor")}const s=new AbortController,c=setTimeout((()=>s.abort()),8e3),u=await Promise.race([r.default.get(`/platos/menu/${e}`,{signal:s.signal}),new Promise(((e,o)=>setTimeout((()=>o(new Error("Timeout al obtener menú del servidor"))),8e3)))]);if(clearTimeout(c),u&&u.success&&u.data){console.log("Menú recuperado desde el servidor:",u.data),i=u.data,i._fromCache=!1;try{const o=await n.e(460).then(n.bind(n,3460));await o.saveMenuToIndexedDB(e,i),console.log("Menú guardado en IndexedDB correctamente")}catch(a){console.warn("No se pudo guardar el menú en IndexedDB:",a)}}else if(console.warn("La respuesta del servidor no contiene datos válidos:",u),i&&i._fromCache)return console.log("Usando datos en caché debido a respuesta inválida del servidor"),i}catch(t){if(console.error("Error al obtener el menú desde el servidor:",t),i&&i._fromCache)return console.log("Usando datos en caché debido a error del servidor"),i;l=!1}}if(!i){try{console.log("Intentando recuperar menú desde IndexedDB...");const o=await n.e(460).then(n.bind(n,3460)),r=await o.getMenuFromIndexedDB(e);r&&r.items&&r.items.length>0?(console.log("Menú recuperado desde IndexedDB:",r),i=r):console.warn("No se encontró el menú en IndexedDB o no contiene items")}catch(s){console.warn("No se pudo obtener el menú desde IndexedDB:",s)}if(!i)try{console.log("Intentando recuperar menú desde localStorage...");const o=localStorage.getItem(`menu_${e}`);if(!o)throw new Error("No se encontró el menú en ninguna caché");i=JSON.parse(o),console.log("Menú recuperado desde localStorage:",i)}catch(o){throw console.error("Error al recuperar menú desde la caché:",o),new Error("No se pudo obtener el menú de ninguna fuente")}}if(i&&!i.businessInfo)try{const e=await(0,r.By)();i.businessInfo=e}catch(c){console.warn("No se pudo obtener información del negocio:",c),i.businessInfo={name:"Restaurante WebSAP",description:"Deliciosa comida para todos los gustos",contact:"info@websap.com",address:"Calle Principal #123",logo:null,paymentInfo:{qrImage:null,qrTitle:"Escanea para pagar",nequiNumber:null,nequiImage:null,bankInfo:"Banco XYZ - Cuenta 123456789",otherPaymentMethods:"Aceptamos efectivo y tarjetas"}}}i&&i.businessInfo&&!i.businessInfo.paymentInfo&&(i.businessInfo.paymentInfo={qrImage:null,qrTitle:"Escanea para pagar",nequiNumber:null,nequiImage:null,bankInfo:"Banco XYZ - Cuenta 123456789",otherPaymentMethods:"Aceptamos efectivo y tarjetas"});try{localStorage.setItem(`menu_${e}`,JSON.stringify(i))}catch(a){console.warn("No se pudo guardar el menú en localStorage:",a)}console.log("[getSharedMenu] Menú recuperado:",i);const u=i?.items?.filter((e=>e.isSpecial))||[],m=i?.items?.filter((e=>!e.isSpecial))||[];return console.log("[getSharedMenu] Items especiales:",u.length),console.log("[getSharedMenu] Items regulares:",m.length),i}catch(i){throw console.error("Error al obtener el menú compartido:",i),i}}async function m(e){try{if(console.log("Sincronizando información del negocio con el backend:",e),!e||0===Object.keys(e).length)return console.error("No hay información del negocio para sincronizar"),{success:!1,message:"No hay información del negocio para sincronizar"};const o=await Promise.resolve().then(n.bind(n,133)),r=o.default,a=localStorage.getItem("token");a&&r.setToken(a);const t=await r.get("/auth/me");if(!t||!t.success||!t.user||!t.user.restaurante_id)return console.warn("No se pudo obtener el restaurante del usuario actual"),{success:!1,message:"No se pudo obtener el restaurante del usuario actual"};const s=t.user.restaurante_id,c=e.paymentInfo||{qrImage:null,qrTitle:"Escanea para pagar",nequiNumber:null,nequiImage:null,bankInfo:"Banco XYZ - Cuenta 123456789",otherPaymentMethods:"Aceptamos efectivo y tarjetas"},i={nombre:e.name||"",descripcion:e.description||"",direccion:e.address||"",telefono:e.contact||"",logo:e.logo||null,informacion_pago:JSON.stringify(c)};console.log("Datos a enviar al backend:",i);const l=await r.put(`/restaurantes/${s}`,i);return l&&l.success?(console.log("Información del negocio sincronizada con éxito"),{success:!0,message:"Información del negocio sincronizada con éxito"}):(console.warn("Error al sincronizar información del negocio:",l),{success:!1,message:l.message||"Error al sincronizar información del negocio"})}catch(o){return console.error("Error al sincronizar información del negocio:",o),{success:!1,message:o.message||"Error al sincronizar información del negocio"}}}},8237:function(e,o,n){var r=n(6518),a=n(2652),t=n(9306),s=n(8551),c=n(1767),i=TypeError;r({target:"Iterator",proto:!0,real:!0},{reduce:function(e){s(this),t(e);var o=c(this),n=arguments.length<2,r=n?void 0:arguments[1],l=0;if(a(o,(function(o){n?(n=!1,r=o):r=e(r,o,l),l++}),{IS_RECORD:!0}),n)throw new i("Reduce of empty iterator with no initial value");return r}})}}]);
//# sourceMappingURL=434.dd15f512.js.map