"use strict";(self["webpackChunkwebsap"]=self["webpackChunkwebsap"]||[]).push([[462],{7081:function(e,n,a){a.r(n),a.d(n,{default:function(){return ge}});var o=a(641),s=a(33),r=a(3751);const i={class:"sync-business-info"},c={class:"status-info"},t={class:"status-item"},l={class:"status-item"},u={class:"settings-section"},d={class:"form-group"},g={class:"toggle-switch"},m={class:"form-group"},f=["disabled"],v={class:"actions"},b=["disabled"],y={key:0,class:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"},p=["disabled"],k={key:0,class:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"},E=["disabled"],I={key:0,class:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"},L=["disabled"],h={key:0,class:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"},w={key:1,class:"current-info"},S={class:"info-card"},z={class:"info-header"},C={class:"info-badge"},A={class:"info-content"},_={class:"info-row"},N={class:"info-row"},R={class:"info-row"},X={key:0,class:"info-row logo-preview"},Q=["src"],j={key:1,class:"info-row"},B={class:"payment-info"},D={key:0},$={key:1},K={key:2},W={class:"sync-log"},x={class:"log-container"},F={class:"log-timestamp"},T={class:"log-message"},M={key:0,class:"log-empty"};function U(e,n,a,U,O,q){return(0,o.uX)(),(0,o.CE)("div",i,[n[26]||(n[26]=(0,o.Lk)("h2",null,"Sincronización de Información del Negocio",-1)),U.message?((0,o.uX)(),(0,o.CE)("div",{key:0,class:(0,s.C4)(["alert",{"alert-success":U.success,"alert-danger":!U.success&&U.message}])},(0,s.v_)(U.message),3)):(0,o.Q3)("",!0),(0,o.Lk)("div",c,[(0,o.Lk)("div",t,[n[8]||(n[8]=(0,o.Lk)("strong",null,"Estado de sincronización:",-1)),(0,o.Lk)("span",{class:(0,s.C4)(U.isAutoSyncEnabled?"status-active":"status-inactive")},(0,s.v_)(U.isAutoSyncEnabled?"Activa":"Inactiva"),3)]),(0,o.Lk)("div",l,[n[9]||(n[9]=(0,o.Lk)("strong",null,"Última sincronización:",-1)),(0,o.Lk)("span",null,(0,s.v_)(U.lastSyncFormatted),1)])]),(0,o.Lk)("div",u,[n[14]||(n[14]=(0,o.Lk)("h3",null,"Configuración de Sincronización",-1)),(0,o.Lk)("div",d,[(0,o.Lk)("label",g,[(0,o.bo)((0,o.Lk)("input",{type:"checkbox","onUpdate:modelValue":n[0]||(n[0]=e=>U.isAutoSyncEnabled=e),onChange:n[1]||(n[1]=(...e)=>U.toggleAutoSync&&U.toggleAutoSync(...e))},null,544),[[r.lH,U.isAutoSyncEnabled]]),n[10]||(n[10]=(0,o.Lk)("span",{class:"slider"},null,-1)),n[11]||(n[11]=(0,o.Lk)("span",{class:"toggle-label"},"Sincronización automática",-1))])]),(0,o.Lk)("div",m,[n[13]||(n[13]=(0,o.Lk)("label",null,"Intervalo de verificación:",-1)),(0,o.bo)((0,o.Lk)("select",{"onUpdate:modelValue":n[2]||(n[2]=e=>U.syncInterval=e),onChange:n[3]||(n[3]=(...e)=>U.updateSyncInterval&&U.updateSyncInterval(...e)),disabled:!U.isAutoSyncEnabled},n[12]||(n[12]=[(0,o.Lk)("option",{value:"15000"},"15 segundos (pruebas)",-1),(0,o.Lk)("option",{value:"30000"},"30 segundos",-1),(0,o.Lk)("option",{value:"60000"},"1 minuto",-1),(0,o.Lk)("option",{value:"300000"},"5 minutos",-1)]),40,f),[[r.u1,U.syncInterval]])])]),(0,o.Lk)("div",v,[(0,o.Lk)("button",{onClick:n[4]||(n[4]=(...e)=>U.runMigration&&U.runMigration(...e)),class:"btn btn-primary",disabled:U.loading},[U.loading?((0,o.uX)(),(0,o.CE)("span",y)):(0,o.Q3)("",!0),n[15]||(n[15]=(0,o.eW)(" Ejecutar Migración "))],8,b),(0,o.Lk)("button",{onClick:n[5]||(n[5]=(...e)=>U.syncBusinessInfo&&U.syncBusinessInfo(...e)),class:"btn btn-success",disabled:U.loading},[U.loading?((0,o.uX)(),(0,o.CE)("span",k)):(0,o.Q3)("",!0),n[16]||(n[16]=(0,o.eW)(" Sincronizar Ahora "))],8,p),(0,o.Lk)("button",{onClick:n[6]||(n[6]=(...e)=>U.fetchFromBackend&&U.fetchFromBackend(...e)),class:"btn btn-info",disabled:U.loading},[U.loading?((0,o.uX)(),(0,o.CE)("span",I)):(0,o.Q3)("",!0),n[17]||(n[17]=(0,o.eW)(" Actualizar desde Servidor "))],8,E),(0,o.Lk)("button",{onClick:n[7]||(n[7]=(...e)=>U.syncAndRefresh&&U.syncAndRefresh(...e)),class:"btn btn-warning",disabled:U.loading},[U.loading?((0,o.uX)(),(0,o.CE)("span",h)):(0,o.Q3)("",!0),n[18]||(n[18]=(0,o.eW)(" Sincronizar y Refrescar "))],8,L)]),U.businessInfo?((0,o.uX)(),(0,o.CE)("div",w,[n[24]||(n[24]=(0,o.Lk)("h3",null,"Información Actual del Negocio",-1)),(0,o.Lk)("div",S,[(0,o.Lk)("div",z,[(0,o.Lk)("h4",null,(0,s.v_)(U.businessInfo.name||"Sin nombre"),1),(0,o.Lk)("div",C,(0,s.v_)(U.lastUpdateFormatted),1)]),(0,o.Lk)("div",A,[(0,o.Lk)("div",_,[n[19]||(n[19]=(0,o.Lk)("strong",null,"Descripción:",-1)),(0,o.eW)(" "+(0,s.v_)(U.businessInfo.description||"Sin descripción"),1)]),(0,o.Lk)("div",N,[n[20]||(n[20]=(0,o.Lk)("strong",null,"Dirección:",-1)),(0,o.eW)(" "+(0,s.v_)(U.businessInfo.address||"Sin dirección"),1)]),(0,o.Lk)("div",R,[n[21]||(n[21]=(0,o.Lk)("strong",null,"Contacto:",-1)),(0,o.eW)(" "+(0,s.v_)(U.businessInfo.contact||"Sin contacto"),1)]),U.businessInfo.logo?((0,o.uX)(),(0,o.CE)("div",X,[n[22]||(n[22]=(0,o.Lk)("strong",null,"Logo:",-1)),(0,o.Lk)("img",{src:U.businessInfo.logo,alt:"Logo",class:"logo-thumbnail"},null,8,Q)])):(0,o.Q3)("",!0),U.businessInfo.paymentInfo?((0,o.uX)(),(0,o.CE)("div",j,[n[23]||(n[23]=(0,o.Lk)("strong",null,"Información de Pago:",-1)),(0,o.Lk)("div",B,[U.businessInfo.paymentInfo.qrTitle?((0,o.uX)(),(0,o.CE)("div",D,"QR: "+(0,s.v_)(U.businessInfo.paymentInfo.qrTitle),1)):(0,o.Q3)("",!0),U.businessInfo.paymentInfo.nequiNumber?((0,o.uX)(),(0,o.CE)("div",$,"Nequi: "+(0,s.v_)(U.businessInfo.paymentInfo.nequiNumber),1)):(0,o.Q3)("",!0),U.businessInfo.paymentInfo.bankInfo?((0,o.uX)(),(0,o.CE)("div",K,"Banco: "+(0,s.v_)(U.businessInfo.paymentInfo.bankInfo),1)):(0,o.Q3)("",!0)])])):(0,o.Q3)("",!0)])])])):(0,o.Q3)("",!0),(0,o.Lk)("div",W,[n[25]||(n[25]=(0,o.Lk)("h3",null,"Registro de Sincronización",-1)),(0,o.Lk)("div",x,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(U.syncLogs,((e,n)=>((0,o.uX)(),(0,o.CE)("div",{key:n,class:(0,s.C4)(["log-entry",{"log-success":e.success,"log-error":!e.success}])},[(0,o.Lk)("div",F,(0,s.v_)(U.formatTimestamp(e.timestamp)),1),(0,o.Lk)("div",T,(0,s.v_)(e.message),1)],2)))),128)),0===U.syncLogs.length?((0,o.uX)(),(0,o.CE)("div",M," No hay registros de sincronización. ")):(0,o.Q3)("",!0)])])])}var O=a(953),q=a(133),V=a(8982),J=a(7051);const H=3e4,P=3e5;let G=null,Y=0,Z=0,ee=null,ne=!1;async function ae(){try{const e=await(0,V.By)();if(!e||0===Object.keys(e).length)return console.log("No hay información del negocio para sincronizar"),{success:!1,message:"No hay información del negocio para sincronizar"};console.log("Sincronizando información del negocio con el backend:",e);const n=localStorage.getItem("token");n&&q["default"].setToken(n);const a=await q["default"].get("/auth/me");if(!a||!a.success||!a.user||!a.user.restaurante_id)return console.warn("No se pudo obtener el restaurante del usuario actual"),{success:!1,message:"No se pudo obtener el restaurante del usuario actual"};const o=a.user.restaurante_id,s={nombre:e.name,descripcion:e.description,direccion:e.address,telefono:e.contact,logo:e.logo,informacion_pago:JSON.stringify(e.paymentInfo||{})},r=await q["default"].put(`/restaurantes/${o}`,s);return r&&r.success?(console.log("Información del negocio sincronizada con éxito"),Y=Date.now(),J.A.emit("business-info-updated",e),{success:!0,message:"Información del negocio sincronizada con éxito",timestamp:Y}):(console.warn("Error al sincronizar información del negocio:",r),{success:!1,message:r.message||"Error al sincronizar información del negocio"})}catch(e){return console.error("Error al sincronizar información del negocio:",e),{success:!1,message:e.message||"Error al sincronizar información del negocio"}}}async function oe(e=!1){try{const a=Date.now();if(ee&&!e&&a-Z<P)return console.log("Usando información de negocio en caché"),ee;const o=localStorage.getItem("token");o&&q["default"].setToken(o);const s=await q["default"].get("/auth/me");if(!s||!s.success||!s.user||!s.user.restaurante_id)throw console.warn("No se pudo obtener el restaurante del usuario actual"),new Error("No se pudo obtener el restaurante del usuario actual");const r=s.user.restaurante_id,i=await q["default"].get(`/restaurantes/${r}`);if(i&&i.success&&i.restaurante){const e=i.restaurante;let o={};try{e.informacion_pago&&(o=JSON.parse(e.informacion_pago))}catch(n){console.warn("Error al parsear información de pago:",n)}const s={name:e.nombre,description:e.descripcion,address:e.direccion,contact:e.telefono,logo:e.logo,paymentInfo:o};return await(0,V.AU)(s),ee=s,Z=a,J.A.emit("business-info-updated",s),console.log("Información del negocio obtenida con éxito:",s),s}throw console.warn("Error al obtener información del negocio:",i),new Error(i?.message||"Error al obtener información del negocio")}catch(a){console.error("Error al obtener información del negocio desde el backend:",a);try{const e=await(0,V.By)();if(e)return e}catch(o){console.error("Error al obtener información local:",o)}throw a}}async function se(){try{const e=await(0,V.By)(),n=await oe(!0),a=JSON.stringify(e),o=JSON.stringify(n),s=a!==o;return s&&(console.log("Se detectaron cambios en la información del negocio"),await(0,V.AU)(n),J.A.emit("business-info-updated",n)),s}catch(e){return console.error("Error al verificar cambios en información del negocio:",e),!1}}function re(e=!1){e?console.log("Sincronización de información del negocio desactivada (modo vista compartida)"):(G&&clearInterval(G),ne||(oe().catch((e=>console.error("Error en sincronización inicial:",e))),ne=!0),G=setInterval((()=>{se().catch((e=>console.error("Error en verificación periódica:",e)))}),H),console.log("Verificación periódica de información del negocio iniciada"))}function ie(){G&&(clearInterval(G),G=null,console.log("Verificación periódica de información del negocio detenida"))}async function ce(){try{const e=localStorage.getItem("token");e&&q["default"].setToken(e);const n=await q["default"].get("/restaurantes/migrate/add-informacion-pago");return n&&n.success?(console.log("Migración ejecutada con éxito:",n.message),{success:!0,message:n.message||"Migración ejecutada con éxito"}):(console.warn("Error al ejecutar migración:",n),{success:!1,message:n.message||"Error al ejecutar migración"})}catch(e){return console.error("Error al ejecutar migración:",e),{success:!1,message:e.message||"Error al ejecutar migración"}}}function te(){ee=null,Z=0}var le={name:"SyncBusinessInfo",setup(){const e=(0,O.KR)(!1),n=(0,O.KR)(!1),a=(0,O.KR)(""),s=(0,O.KR)(null),r=(0,O.KR)(null),i=(0,O.KR)(null),c=(0,O.KR)(!0),t=(0,O.KR)("30000"),l=(0,O.KR)([]),u=(0,o.EW)((()=>r.value?g(r.value):"Nunca")),d=(0,o.EW)((()=>i.value?`Actualizado: ${g(i.value)}`:"")),g=e=>{if(!e)return"";const n=new Date(e);return`${n.toLocaleDateString()} ${n.toLocaleTimeString()}`},m=(e,n=!0)=>{l.value.unshift({message:e,success:n,timestamp:Date.now()}),l.value.length>10&&(l.value=l.value.slice(0,10))},f=e=>{s.value=e,i.value=Date.now(),m("Información del negocio actualizada")};(0,o.sV)((async()=>{try{J.A.on("business-info-updated",f),await v(),c.value&&(re(),m("Sincronización automática iniciada"))}catch(e){console.error("Error al montar el componente:",e),a.value="Error al cargar información del negocio",n.value=!1,m("Error al cargar información del negocio",!1)}})),(0,o.hi)((()=>{J.A.off("business-info-updated",f),ie()}));const v=async()=>{try{e.value=!0,s.value=await(0,V.By)(),i.value=Date.now()}catch(o){console.error("Error al cargar información del negocio:",o),a.value="Error al cargar información del negocio",n.value=!1,m("Error al cargar información del negocio",!1)}finally{e.value=!1}},b=async()=>{try{e.value=!0,a.value="Ejecutando migración...";const o=await ce();n.value=o.success,a.value=o.message,o.success?m("Migración ejecutada con éxito"):m(`Error en migración: ${o.message}`,!1)}catch(o){console.error("Error al ejecutar migración:",o),n.value=!1,a.value=o.message||"Error al ejecutar migración",m(`Error en migración: ${o.message}`,!1)}finally{e.value=!1}},y=async()=>{try{e.value=!0,a.value="Sincronizando información...";const o=await ae();n.value=o.success,a.value=o.message,o.success?(r.value=o.timestamp||Date.now(),await v(),m("Sincronización completada con éxito")):m(`Error en sincronización: ${o.message}`,!1)}catch(o){console.error("Error al sincronizar información:",o),n.value=!1,a.value=o.message||"Error al sincronizar información",m(`Error en sincronización: ${o.message}`,!1)}finally{e.value=!1}},p=async()=>{try{e.value=!0,a.value="Obteniendo información desde el servidor...",te(),s.value=await oe(!0),n.value=!0,a.value="Información actualizada desde el servidor",i.value=Date.now(),m("Información actualizada desde el servidor")}catch(o){console.error("Error al obtener información desde el servidor:",o),n.value=!1,a.value=o.message||"Error al obtener información desde el servidor",m(`Error al obtener información: ${o.message}`,!1)}finally{e.value=!1}},k=async()=>{try{e.value=!0,a.value="Sincronizando y verificando cambios...",await ae();const o=await se();o?(n.value=!0,a.value="Se detectaron y aplicaron cambios en la información",m("Se detectaron y aplicaron cambios")):(n.value=!0,a.value="No se detectaron cambios en la información",m("No se detectaron cambios")),await v(),r.value=Date.now()}catch(o){console.error("Error al sincronizar y verificar cambios:",o),n.value=!1,a.value=o.message||"Error al sincronizar y verificar cambios",m(`Error al sincronizar: ${o.message}`,!1)}finally{e.value=!1}},E=()=>{c.value?(re(),m("Sincronización automática activada")):(ie(),m("Sincronización automática desactivada"))},I=()=>{ie(),m(`Intervalo de sincronización actualizado a ${parseInt(t.value)/1e3} segundos`),c.value&&re()};return{loading:e,success:n,message:a,businessInfo:s,lastSync:r,lastSyncFormatted:u,lastUpdateFormatted:d,isAutoSyncEnabled:c,syncInterval:t,syncLogs:l,runMigration:b,syncBusinessInfo:y,fetchFromBackend:p,syncAndRefresh:k,toggleAutoSync:E,updateSyncInterval:I,formatTimestamp:g}}},ue=a(6262);const de=(0,ue.A)(le,[["render",U],["__scopeId","data-v-36ce8d12"]]);var ge=de}}]);
//# sourceMappingURL=462.9fa985ef.js.map