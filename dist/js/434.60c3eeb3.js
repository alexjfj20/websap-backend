"use strict";(self["webpackChunkwebsap"]=self["webpackChunkwebsap"]||[]).push([[434],{5226:function(e,o,n){n.d(o,{Dy:function(){return d},rJ:function(){return u}});n(8111),n(2489),n(1701);var r=n(8982);const a="websapDatabase",t=3,s="sharedMenus",c="menuImages";function i(){return new Promise(((e,o)=>{try{console.log("Intentando abrir la base de datos con versión:",t);const n=indexedDB.open(a,t);n.onerror=e=>{console.error("Error al abrir la base de datos:",e.target.error),o("Error al abrir la base de datos: "+e.target.errorCode)},n.onsuccess=n=>{const r=n.target.result;console.log("Base de datos abierta con éxito, versión:",r.version);const a=Array.from(r.objectStoreNames);if(console.log("Almacenes existentes:",a),!a.includes(s))return console.error(`El almacén ${s} no existe en la base de datos`),void o(new Error(`El almacén ${s} no existe en la base de datos`));e(r)},n.onupgradeneeded=e=>{console.log("Actualizando estructura de la base de datos a versión:",e.newVersion);const o=e.target.result;o.objectStoreNames.contains(s)||(console.log("Creando almacén:",s),o.createObjectStore(s,{keyPath:"id"})),o.objectStoreNames.contains(c)||(console.log("Creando almacén:",c),o.createObjectStore(c,{keyPath:"id"}))}}catch(n){console.error("Error crítico en IndexedDB:",n),o(n)}}))}function l(){return Math.random().toString(36).substring(2,10)+Math.random().toString(36).substring(2,10)}async function d(e){try{const n=l(),a=await(0,r.By)(),t=await Promise.all(e.map((async e=>{const o={...e};if(o.isSpecial=Boolean(e.isSpecial),console.log(`[saveMenu] Guardando ${e.name} con isSpecial=${o.isSpecial}`),o.image&&"string"===typeof o.image&&o.image.length>0)try{o.image=await(0,r.w4)(o.image,400,300,.5)}catch(n){console.warn("Error al comprimir imagen:",n),o.image=null}return o}))),c={id:n,items:t,businessInfo:a,createdAt:(new Date).toISOString()};try{const e=JSON.stringify(c).length/1048576;if(console.log(`Tamaño del menú a guardar: ${e.toFixed(2)} MB`),e>50)throw new Error(`El menú es demasiado grande (${e.toFixed(2)} MB). Reduce el tamaño de las imágenes.`)}catch(o){throw console.error("Error al verificar tamaño del menú:",o),new Error("Error al verificar tamaño del menú")}const d=await i(),u=d.transaction([s],"readwrite"),g=u.objectStore(s);return await new Promise(((e,o)=>{const r=g.put(c);r.onsuccess=()=>{console.log(`Menú guardado exitosamente con ID: ${n}`),e()},r.onerror=e=>{console.error("Error al guardar el menú:",e.target.error),o(e.target.error)}})),console.log("[saveMenu] Items a guardar:",e.length),console.log("[saveMenu] Items especiales:",e.filter((e=>e.isSpecial)).length),console.log("[saveMenu] Items regulares:",e.filter((e=>!e.isSpecial)).length),await m(),n}catch(o){throw console.error("Error al guardar el menú compartido:",o),o}}async function u(e){try{if(console.log(`Intentando recuperar menú con ID: ${e}`),!e)return console.error("ID de menú no proporcionado"),null;let l=null,d=navigator.onLine;console.log("Estado de conexión: "+(d?"Online":"Offline"));const u=async()=>{try{const e=new AbortController,o=setTimeout((()=>e.abort()),3e3),n=await fetch("/api/ping",{signal:e.signal,cache:"no-store",headers:{"Cache-Control":"no-cache"}});return clearTimeout(o),n.ok}catch(e){return console.log("Error al verificar conexión real:",e),!1}};try{console.log("Intentando cargar menú desde caché mientras verificamos conexión...");const o=await n.e(460).then(n.bind(n,3460)),r=await o.getMenuFromIndexedDB(e);r&&r.items&&r.items.length>0&&(console.log("Menú en caché encontrado y listo para uso inmediato"),l=r,l._fromCache=!0)}catch(o){console.warn("No se pudo obtener menú en caché para uso inmediato:",o)}if(d){console.log(`Obteniendo menú fresco desde el servidor con ID: ${e}`);try{const o=u(),r=await Promise.resolve().then(n.bind(n,133)),c=await o;if(!c){if(console.warn("Detectada conexión inestable o sin acceso al servidor"),d=!1,l)return l;throw new Error("Sin conexión real al servidor")}if(!l||window.location.href.includes("/websap/menu/"))try{console.log("Intentando recuperar menú desde el servidor...");const o=await r.get(`/platos/menu/${e}`);if(!(o&&o.success&&o.data))throw console.warn("No se pudo recuperar el menú desde el servidor:",o),new Error("No se pudo obtener el menú desde el servidor.");l=o.data,console.log("Menú recuperado desde el servidor:",l)}catch(a){if(console.error("Error al recuperar el menú desde el servidor:",a),!l)throw new Error("No se pudo obtener el menú desde el servidor y no hay datos en caché.")}if(!l)try{console.log("Intentando recuperar menú desde IndexedDB...");const o=await n.e(460).then(n.bind(n,3460)),r=await o.getMenuFromIndexedDB(e);r&&r.items&&r.items.length>0?(console.log("Menú recuperado desde IndexedDB:",r),l=r):console.warn("No se encontró el menú en IndexedDB o no contiene items")}catch(t){console.warn("No se pudo obtener el menú desde IndexedDB:",t)}const i=new AbortController,m=setTimeout((()=>i.abort()),8e3),g=await Promise.race([r.default.get(`/platos/menu/${e}`,{signal:i.signal}),new Promise(((e,o)=>setTimeout((()=>o(new Error("Timeout al obtener menú del servidor"))),8e3)))]);if(clearTimeout(m),g&&g.success&&g.data){console.log("Menú recuperado desde el servidor:",g.data),l=g.data,l._fromCache=!1;try{const o=await n.e(460).then(n.bind(n,3460));await o.saveMenuToIndexedDB(e,l),console.log("Menú guardado en IndexedDB correctamente")}catch(s){console.warn("No se pudo guardar el menú en IndexedDB:",s)}}else if(console.warn("La respuesta del servidor no contiene datos válidos:",g),l&&l._fromCache)return console.log("Usando datos en caché debido a respuesta inválida del servidor"),l}catch(c){if(console.error("Error al obtener el menú desde el servidor:",c),l&&l._fromCache)return console.log("Usando datos en caché debido a error del servidor"),l;d=!1}}if(!l){try{console.log("Intentando recuperar menú desde IndexedDB...");const o=await n.e(460).then(n.bind(n,3460)),r=await o.getMenuFromIndexedDB(e);r&&r.items&&r.items.length>0?(console.log("Menú recuperado desde IndexedDB:",r),l=r):console.warn("No se encontró el menú en IndexedDB o no contiene items")}catch(t){console.warn("No se pudo obtener el menú desde IndexedDB:",t)}if(!l)try{console.log("Intentando recuperar menú desde localStorage...");const o=localStorage.getItem(`menu_${e}`);if(!o)throw new Error("No se encontró el menú en ninguna caché");l=JSON.parse(o),console.log("Menú recuperado desde localStorage:",l)}catch(o){throw console.error("Error al recuperar menú desde la caché:",o),new Error("No se pudo obtener el menú de ninguna fuente")}}if(l&&!l.businessInfo)try{const e=await(0,r.By)();l.businessInfo=e}catch(i){console.warn("No se pudo obtener información del negocio:",i),l.businessInfo={name:"Restaurante WebSAP",description:"Deliciosa comida para todos los gustos",contact:"info@websap.com",address:"Calle Principal #123",logo:null,paymentInfo:{qrImage:null,qrTitle:"Escanea para pagar",nequiNumber:null,nequiImage:null,bankInfo:"Banco XYZ - Cuenta 123456789",otherPaymentMethods:"Aceptamos efectivo y tarjetas"}}}l&&l.businessInfo&&!l.businessInfo.paymentInfo&&(l.businessInfo.paymentInfo={qrImage:null,qrTitle:"Escanea para pagar",nequiNumber:null,nequiImage:null,bankInfo:"Banco XYZ - Cuenta 123456789",otherPaymentMethods:"Aceptamos efectivo y tarjetas"});try{localStorage.setItem(`menu_${e}`,JSON.stringify(l))}catch(s){console.warn("No se pudo guardar el menú en localStorage:",s)}console.log("[getSharedMenu] Menú recuperado:",l);const m=l?.items?.filter((e=>e.isSpecial))||[],g=l?.items?.filter((e=>!e.isSpecial))||[];return console.log("[getSharedMenu] Items especiales:",m.length),console.log("[getSharedMenu] Items regulares:",g.length),l}catch(c){throw console.error("Error al obtener el menú compartido:",c),c}}async function m(e){try{if(console.log("Sincronizando información del negocio con el backend:",e),!e||0===Object.keys(e).length)return console.error("No hay información del negocio para sincronizar"),{success:!1,message:"No hay información del negocio para sincronizar"};const o=await Promise.resolve().then(n.bind(n,133)),r=o.default,a=localStorage.getItem("token");a&&r.setToken(a);const t=await r.get("/auth/me");if(!t||!t.success||!t.user||!t.user.restaurante_id)return console.warn("No se pudo obtener el restaurante del usuario actual"),{success:!1,message:"No se pudo obtener el restaurante del usuario actual"};const s=t.user.restaurante_id,c=e.paymentInfo||{qrImage:null,qrTitle:"Escanea para pagar",nequiNumber:null,nequiImage:null,bankInfo:"Banco XYZ - Cuenta 123456789",otherPaymentMethods:"Aceptamos efectivo y tarjetas"},i={nombre:e.name||"",descripcion:e.description||"",direccion:e.address||"",telefono:e.contact||"",logo:e.logo||null,informacion_pago:JSON.stringify(c)};console.log("Datos a enviar al backend:",i);const l=await r.put(`/restaurantes/${s}`,i);return l&&l.success?(console.log("Información del negocio sincronizada con éxito"),{success:!0,message:"Información del negocio sincronizada con éxito"}):(console.warn("Error al sincronizar información del negocio:",l),{success:!1,message:l.message||"Error al sincronizar información del negocio"})}catch(o){return console.error("Error al sincronizar información del negocio:",o),{success:!1,message:o.message||"Error al sincronizar información del negocio"}}}},8237:function(e,o,n){var r=n(6518),a=n(2652),t=n(9306),s=n(8551),c=n(1767),i=TypeError;r({target:"Iterator",proto:!0,real:!0},{reduce:function(e){s(this),t(e);var o=c(this),n=arguments.length<2,r=n?void 0:arguments[1],l=0;if(a(o,(function(o){n?(n=!1,r=o):r=e(r,o,l),l++}),{IS_RECORD:!0}),n)throw new i("Reduce of empty iterator with no initial value");return r}})}}]);
//# sourceMappingURL=434.60c3eeb3.js.map